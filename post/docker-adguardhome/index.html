<!doctype html><html lang=en><head><meta charset=utf-8><meta name=referrer content="same-origin"><title>Docker adguardhome记录 :: ywy — 有约不来过夜半，闲敲棋子落灯花</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="安装 docker pull adguard/adguardhome:arm64-latest桥接macnet ip link set eth0 promisc on docker network create -d macvlan --subnet=192.168.2.0/24 --gateway=192.168.2.1 -o parent=eth0 macnet 启动 docker run --name adguardhome -v /root/AdguardHome/workdir:/opt/adguardhome/work -v /root/AdguardHome/confdir:/opt/adguardhome/conf"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://ywycd.github.io/post/docker-adguardhome/><link rel=stylesheet href=https://ywycd.github.io/assets/style.min.css?d41d8cd98f00b204e9800998ecf8427e><link rel=apple-touch-icon-precomposed sizes=180x180 href=https://ywycd.github.io/img/apple-icon-precomposed.png><link rel="shortcut icon" href=https://ywycd.github.io/img/apple-touch-icon-rm.png><meta name=twitter:card content="summary"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Docker adguardhome记录 :: ywy"><meta property="og:description" content="安装 docker pull adguard/adguardhome:arm64-latest桥接macnet ip link set eth0 promisc on docker network create -d macvlan --subnet=192.168.2.0/24 --gateway=192.168.2.1 -o parent=eth0 macnet 启动 docker run --name adguardhome -v /root/AdguardHome/workdir:/opt/adguardhome/work -v /root/AdguardHome/confdir:/opt/adguardhome/conf"><meta property="og:url" content="https://ywycd.github.io/post/docker-adguardhome/"><meta property="og:site_name" content="ywy"><meta property="og:image" content="https://ywycd.github.io/img/apple-touch-icon-rm.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2020-03-13 17:44:32 +0800 +0800"></head><body><div class="container center headings--one-size"><header class=header style=background-image:url(/img/banner-rain-731313_1920.png);background-position:50%;background-repeat:no-repeat;background-size:cover><div class=header__inner><div class=header__logo><a href=https://ywycd.github.io/><div class=logo>ASDW</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li><li><a href=/tagcloud>TagCloud</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li><li><a href=/tagcloud>TagCloud</a></li></ul></nav><div class=feed-links></div></header><div class=content><div class=post><h1 class=post-title>Docker adguardhome记录</h1><div class=post-meta><span class=post-date>2020-03-13</span>
<span class=post-author>::
ywy</span>
:: Mod 2021-01-09(a8e05c5)</div><span class=post-tags>#<a href=https://ywycd.github.io/tags/docker/>docker</a>&nbsp;
#<a href=https://ywycd.github.io/tags/old/>old</a>&nbsp;</span><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#安装>安装</a><ul><li><a href=#桥接macnet>桥接macnet</a></li><li><a href=#host模式>host模式</a></li></ul></li><li><a href=#设置>设置</a><ul><li><a href=#上游dns>上游dns</a></li><li><a href=#规则>规则</a></li></ul></li><li><a href=#忘记密码>忘记密码</a></li></ul></nav></div></div><div class=post-content><div><h2 id=安装>安装<a href=#安装 class=hanchor arialabel=Anchor>&#8983;</a></h2><div class=highlight><pre class=chroma><code class=language-docker data-lang=docker>    docker pull adguard/adguardhome:arm64-latest<span class=err>
</span></code></pre></div><h3 id=桥接macnet>桥接macnet<a href=#桥接macnet class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre class=chroma><code class=language-docker data-lang=docker>    ip link <span class=nb>set</span> eth0 promisc on<span class=err>
</span><span class=err></span>    docker network create -d macvlan --subnet<span class=o>=</span>192.168.2.0/24 --gateway<span class=o>=</span>192.168.2.1 -o <span class=nv>parent</span><span class=o>=</span>eth0 macnet <span class=err>
</span></code></pre></div><p>启动</p><div class=highlight><pre class=chroma><code class=language-docker data-lang=docker>    docker run --name adguardhome -v /root/AdguardHome/workdir:/opt/adguardhome/work -v /root/AdguardHome/confdir:/opt/adguardhome/conf -d --network macnet --ip 192.168.2.143 --restart always adguard/adguardhome:arm64-latest <span class=err>
</span></code></pre></div><p>主路由设置lan口网关、dns，有统计，但xx上网速度不行</p><h3 id=host模式>host模式<a href=#host模式 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>删除旧容器、设置</p><div class=highlight><pre class=chroma><code class=language-docker data-lang=docker>    docker stop adguardhome<span class=err>
</span><span class=err></span>    docker rm adguardhome<span class=err>
</span><span class=err></span>    rm -rf /root/AdguardHome/confdir/*<span class=err>
</span><span class=err></span>    rm -rf /root/AdguardHome/workdir/*<span class=err>
</span></code></pre></div><p>启动</p><div class=highlight><pre class=chroma><code class=language-docker data-lang=docker>    docker run --name adguardhome <span class=se>\
</span><span class=se></span>            -v /root/AdguardHome/workdir:/opt/adguardhome/work <span class=se>\
</span><span class=se></span>            -v /root/AdguardHome/confdir:/opt/adguardhome/conf <span class=se>\
</span><span class=se></span>            --restart always <span class=se>\
</span><span class=se></span>            --net host <span class=se>\
</span><span class=se></span>            -d adguard/adguardhome:arm64-latest<span class=err>
</span></code></pre></div><p>端口改成1080、1053,指定网关不行。老毛子设置转发(分开填入），统计里只有路由器一个客户端</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>all-servers
<span class=nv>server</span><span class=o>=</span>192.168.1.144#1053 <span class=c1>#AdGuardHome</span>
</code></pre></div><p><a href="https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=2635946&extra=page%3D2%26filter%3Dtypeid%26typeid%3D21&page=1">这个</a> 提示后只修改80端口,修改dns成功。但必须添加防火墙规则才能上网。
<code>iptables -t nat -I POSTROUTING -o eth0 -j MASQUERADE</code></p><p>小钢炮开启enware,安装cutter、iptables,加规则无门时发现有个iptables-save命令。运行重启路由、小钢炮，可以正常上网，ok。</p><p>双开adg再试</p><h2 id=设置>设置<a href=#设置 class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=上游dns>上游dns<a href=#上游dns class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre class=chroma><code class=language-html data-lang=html>1.2.4.8
223.5.5.5
119.29.29.29
114.114.114.114
https://dns.rubyfish.cn/dns-query
tls://dns.google
tls://1.1.1.1
</code></pre></div><p>勾选 同时查询。Bootstrap DNS 服务器 <code>114.114.114.114:53</code>，测试上游后应用</p><h3 id=规则>规则<a href=#规则 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre class=chroma><code class=language-html data-lang=html>https://hosts.nfz.moe/full/hosts
https://gitee.com/banbendalao/adguard/raw/master/ADgk.txt
https://gitee.com/privacy-protection-tools/anti-ad/raw/master/easylist.txt
</code></pre></div><p>修改AdGuardHome.yaml里的</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml><span class=w>  </span><span class=k>blocked_response_ttl</span><span class=p>:</span><span class=w> </span><span class=m>60</span><span class=w>
</span><span class=w>  </span><span class=k>ratelimit</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></code></pre></div><p>重启容器</p><h2 id=忘记密码>忘记密码<a href=#忘记密码 class=hanchor arialabel=Anchor>&#8983;</a></h2><p><a href=https://github.com/AdguardTeam/AdGuardHome/wiki/Configuration#password-reset>wiki</a> 安装Apache2，自带htpasswd。用termux
使用htpasswd生成加密密码，linux用下面命令。输出结果是<code>&lt;USERNAME>:&lt;HASH></code></p><p><code>htpasswd -B -n -b &lt;USERNAME> &lt;PASSWORD></code>
编辑AdGuardHome.yaml，替换相应内容。</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml><span class=w>     </span><span class=k>users</span><span class=p>:</span><span class=w>
</span><span class=w>     </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>...<span class=w>
</span><span class=w>     </span><span class=k>password</span><span class=p>:</span><span class=w> </span>&lt;HASH&gt;<span class=w>
</span></code></pre></div><p>开始使用<code>&lt;USERNAME> &lt;PASSWORD></code>，发现登陆不上。termux用&lt;>错误，改成[]生成。window提示语法错误。
注意到<code>password: &lt;HASH></code>，灵感一来不加括号，登陆成功。&lt;>应该是提示可修改。</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://ywycd.github.io/post/docker-clash/><span class=button__icon>←</span>
<span class=button__text>Docker Clash记录</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>:: Powered by <a href=http://gohugo.io>Hugo</a> 0.74.3</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><a id=back-to-top style=display:inline-block href=javascript:void(0); onclick="window.scrollTo({top:0,behavior:'smooth'});"><span class="iconfont icon-top"></span></a><script src=https://ywycd.github.io/assets/main.js?d41d8cd98f00b204e9800998ecf8427e></script><script>const addCopyButtons=function(clipboard){document.querySelectorAll('pre > code').forEach(function(codeBlock){const button=document.createElement('button');button.className='copy-code-button';button.type='button';button.innerText='Copy';const btnWrapper=document.createElement('div');btnWrapper.className='copy-code-button-wrap';btnWrapper.appendChild(button);button.addEventListener('click',function(){clipboard.writeText(codeBlock.innerText).then(function(){button.blur();button.innerText='Done!';setTimeout(function(){button.innerText='Copy';},2000);},function(error){button.innerText='Error';});});const pre=codeBlock.parentNode;pre.insertAdjacentElement('beforebegin',btnWrapper);});};window.addEventListener('load',function(event){const links=document.links;for(let i=0,linksLength=links.length;i<linksLength;i++){if(links[i].hostname!=window.location.hostname&&!links[i].href.startsWith('javascript:')&&!links[i].href.startsWith('mailto:')){links[i].target='_blank';}}
if(document.querySelectorAll('#TableOfContents li').length>0){document.querySelector('#post-toc').style.display='block';}
document.querySelectorAll('#post-toc a').forEach(anchor=>{anchor.addEventListener('click',evt=>{document.querySelectorAll('#post-toc a').forEach(ele=>{ele.classList.remove('active');});evt.target.classList.add('active');})});document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener('click',function(e){e.preventDefault();document.getElementById(this.getAttribute('href').substring(1)).scrollIntoView({behavior:'smooth'});});});if(navigator&&navigator.clipboard){addCopyButtons(navigator.clipboard);}});</script></div></body></html>