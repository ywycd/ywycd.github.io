<!doctype html><html lang=en><head><meta charset=utf-8><meta name=referrer content="same-origin"><title>Docker Clash记录 :: ywy — 有约不来过夜半，闲敲棋子落灯花</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="起因： clash N多分支，体验了luci openclash不稳定，改动后经常失效，换成docker clash。 配置文件准备 docker-compose.yml 启动clash version:&amp;#39;3.4&amp;#39;services:clash:image:dreamacro/clash:latest-arm64v8volumes:- ./config.yaml:/root/.config/clash/config.yaml- ./dashboard:/uiports:- &amp;#34;7890:7890&amp;#34;- &amp;#34;7891:7891&amp;#34;-"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://ywycd.github.io/post/docker-clash/><link rel=stylesheet href=https://ywycd.github.io/assets/style.min.css?d41d8cd98f00b204e9800998ecf8427e><link rel=apple-touch-icon-precomposed sizes=180x180 href=https://ywycd.github.io/img/apple-icon-precomposed.png><link rel="shortcut icon" href=https://ywycd.github.io/img/apple-touch-icon-rm.png><meta name=twitter:card content="summary"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Docker Clash记录 :: ywy"><meta property="og:description" content="起因： clash N多分支，体验了luci openclash不稳定，改动后经常失效，换成docker clash。 配置文件准备 docker-compose.yml 启动clash version:&amp;#39;3.4&amp;#39;services:clash:image:dreamacro/clash:latest-arm64v8volumes:- ./config.yaml:/root/.config/clash/config.yaml- ./dashboard:/uiports:- &amp;#34;7890:7890&amp;#34;- &amp;#34;7891:7891&amp;#34;-"><meta property="og:url" content="https://ywycd.github.io/post/docker-clash/"><meta property="og:site_name" content="ywy"><meta property="og:image" content="https://ywycd.github.io/img/apple-touch-icon-rm.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2020-05-17 13:10:41 +0800 +0800"></head><body><div class="container center headings--one-size"><header class=header style=background-image:url(/img/banner-rain-731313_1920.png);background-position:50%;background-repeat:no-repeat;background-size:cover><div class=header__inner><div class=header__logo><a href=https://ywycd.github.io/><div class=logo>ASDW</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li><li><a href=/tagcloud>TagCloud</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li><li><a href=/tagcloud>TagCloud</a></li></ul></nav><div class=feed-links></div></header><div class=content><div class=post><h1 class=post-title>Docker Clash记录</h1><div class=post-meta><span class=post-date>2020-05-17</span>
<span class=post-author>::
ywy</span>
:: Mod 2021-01-09(a8e05c5)</div><span class=post-tags>#<a href=https://ywycd.github.io/tags/docker/>docker</a>&nbsp;
#<a href=https://ywycd.github.io/tags/old/>old</a>&nbsp;</span><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#配置文件准备>配置文件准备</a><ul><li><a href=#docker-composeyml>docker-compose.yml</a></li><li><a href=#configyaml>config.yaml</a></li></ul></li><li><a href=#启动clash>启动clash</a></li></ul></nav></div></div><div class=post-content><div><p>起因：
<a href=https://github.com/Dreamacro/clash>clash</a> N多分支，体验了luci openclash不稳定，改动后经常失效，换成docker clash。</p><h2 id=配置文件准备>配置文件准备<a href=#配置文件准备 class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=docker-composeyml>docker-compose.yml<a href=#docker-composeyml class=hanchor arialabel=Anchor>&#8983;</a></h3><p>启动clash</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml><span class=w>    </span><span class=k>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.4&#39;</span><span class=w>
</span><span class=w>    </span><span class=k>services</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>clash</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>image</span><span class=p>:</span><span class=w> </span>dreamacro/clash<span class=p>:</span>latest-arm64v8<span class=w>
</span><span class=w>        </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- ./config.yaml<span class=p>:</span>/root/.config/clash/config.yaml<span class=w>
</span><span class=w>          </span>- ./dashboard<span class=p>:</span>/ui<span class=w>
</span><span class=w>        </span><span class=k>ports</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=s2>&#34;7890:7890&#34;</span><span class=w>
</span><span class=w>          </span>- <span class=s2>&#34;7891:7891&#34;</span><span class=w>
</span><span class=w>          </span>- <span class=s2>&#34;7892:7892&#34;</span><span class=w>
</span><span class=w>          </span>- <span class=s2>&#34;9090:9090&#34;</span><span class=w>
</span><span class=w>          </span>- <span class=s2>&#34;1053:1053&#34;</span><span class=w>
</span><span class=w>        </span><span class=k>restart</span><span class=p>:</span><span class=w> </span>always<span class=w>
</span><span class=w>        </span><span class=c># When your system is Linux, you can use `network_mode: &#34;host&#34;` directly.</span><span class=w>
</span><span class=w>        </span><span class=k>network_mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;host&#34;</span><span class=w>
</span><span class=w>        </span><span class=k>container_name</span><span class=p>:</span><span class=w> </span>clash<span class=w>
</span></code></pre></div><p>9090是web ui端口。1053 dns端口，小钢炮53端口被占。<code>volumes:- ./dashboard:/ui</code> /宿主机路径:/容器路径，开始这里不明白，错了好几回。
UI有两种
<a href=https://github.com/Dreamacro/clash-dashboard/tree/gh-pages>官方</a>，<code>http://localhost:9090/ui</code>
<a href=https://github.com/haishanh/yacd/tree/gh-pages>yacd</a>节点收起。<code>http://localhost:8080/</code>。网页版http://yacd.haishan.me/，登陆后可看。
两种ui都用的话，另一种要nignx加载。学习了
<a href=https://www.ruanyifeng.com/blog/2018/02/nginx-docker.html>&ndash;rm指令</a>，容器停止就会删除。</p><h3 id=configyaml>config.yaml<a href=#configyaml class=hanchor arialabel=Anchor>&#8983;</a></h3><p>代理配置
<a href=https://gist.githubusercontent.com/lddsb/b041bb03a8c1295a77d00a5235636ec1/raw/21f0731f40fd53f7b47ad6e45f17f15c811f6b3e/config.yml>示例</a></p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml><span class=w>    </span><span class=k>port</span><span class=p>:</span><span class=w> </span><span class=m>7890</span><span class=w>
</span><span class=w>    </span><span class=k>socks-port</span><span class=p>:</span><span class=w> </span><span class=m>7891</span><span class=w>
</span><span class=w>    </span><span class=k>allow-lan</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=k>external-controller</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>8080</span><span class=w>
</span></code></pre></div><p>照搬openclash设定，订阅转换参考
<a href=https://github.com/tindy2013/subconverter>subconverter</a></p><h2 id=启动clash>启动clash<a href=#启动clash class=hanchor arialabel=Anchor>&#8983;</a></h2><p>进入放置两个配置文件目录，运行<code>docker-compose up -d</code> 。查看clash日志，会发现5个端口在监听，代理节点规则加载。日常用SwitchyOmega连接sock5节点，细分网站代理。</p><p>还可以局域网转发，有点难，没尝试过。docker里有clash网关。</p><p>参考网址：</p><ol><li><a href=https://zmcdbp.com/run-clash-in-docker/>在Docker中使用Clash</a></li><li><a href=https://wuyefan.wordpress.com/2020/02/12/clash-docker-openwrt-%E9%85%8D%E7%BD%AE%E4%B8%8E%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/amp/>Clash Docker & Openwrt 配置与踩坑记录</a></li></ol></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://ywycd.github.io/post/buy-hetzner/><span class=button__icon>←</span>
<span class=button__text>Hetzner折腾</span></a></span>
<span class="button next"><a href=https://ywycd.github.io/post/docker-adguardhome/><span class=button__text>Docker adguardhome记录</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>:: Powered by <a href=http://gohugo.io>Hugo</a> 0.74.3</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><a id=back-to-top style=display:inline-block href=javascript:void(0); onclick="window.scrollTo({top:0,behavior:'smooth'});"><span class="iconfont icon-top"></span></a><script src=https://ywycd.github.io/assets/main.js?d41d8cd98f00b204e9800998ecf8427e></script><script>const addCopyButtons=function(clipboard){document.querySelectorAll('pre > code').forEach(function(codeBlock){const button=document.createElement('button');button.className='copy-code-button';button.type='button';button.innerText='Copy';const btnWrapper=document.createElement('div');btnWrapper.className='copy-code-button-wrap';btnWrapper.appendChild(button);button.addEventListener('click',function(){clipboard.writeText(codeBlock.innerText).then(function(){button.blur();button.innerText='Done!';setTimeout(function(){button.innerText='Copy';},2000);},function(error){button.innerText='Error';});});const pre=codeBlock.parentNode;pre.insertAdjacentElement('beforebegin',btnWrapper);});};window.addEventListener('load',function(event){const links=document.links;for(let i=0,linksLength=links.length;i<linksLength;i++){if(links[i].hostname!=window.location.hostname&&!links[i].href.startsWith('javascript:')&&!links[i].href.startsWith('mailto:')){links[i].target='_blank';}}
if(document.querySelectorAll('#TableOfContents li').length>0){document.querySelector('#post-toc').style.display='block';}
document.querySelectorAll('#post-toc a').forEach(anchor=>{anchor.addEventListener('click',evt=>{document.querySelectorAll('#post-toc a').forEach(ele=>{ele.classList.remove('active');});evt.target.classList.add('active');})});document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener('click',function(e){e.preventDefault();document.getElementById(this.getAttribute('href').substring(1)).scrollIntoView({behavior:'smooth'});});});if(navigator&&navigator.clipboard){addCopyButtons(navigator.clipboard);}});</script></div></body></html>